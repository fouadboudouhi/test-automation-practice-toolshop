# Docker Compose stack for the "Practice Software Testing" (Sprint 5) AUT.
#
# What this brings up
# -------------------
# 1) mariadb      -> database (internal only; no host port binding)
# 2) laravel-api  -> Laravel backend (PHP-FPM on :9000 inside the container)
# 3) web          -> Nginx reverse-proxy serving /public and forwarding PHP to laravel-api:9000
# 4) angular-ui   -> Angular dev server exposed on the host (UI_PORT)
#
# Key design decisions
# --------------------
# - No DB host port mapping:
#   Avoids "Bind for 0.0.0.0:3306 failed" conflicts on developer machines / CI runners.
# - Pinned images (by digest) for sprint 5:
#   Increases reproducibility across machines and CI.
# - Shared named volume (laravel-app-code):
#   The Laravel container populates /var/www; Nginx reads the same code as read-only.

services:
  mariadb:
    image: yobasystems/alpine-mariadb:10.6.11

    # IMPORTANT: No host port mapping on purpose (prevents port conflicts on 3306).
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_USER: user
      MYSQL_PASSWORD: root
      MYSQL_DATABASE: toolshop

    # Healthcheck used by tooling/Makefile to wait until DB is ready.
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "mysqladmin ping -h 127.0.0.1 -uroot -proot --silent || exit 1",
        ]
      interval: 2s
      timeout: 2s
      retries: 60

  laravel-api:
    # Sprint 5 backend image pinned by digest (reproducible).
    image: testsmith/practice-software-testing-sprint5-api@sha256:168c99e1f626005cc126dddf3aacf28c6362022f4bab72f41c01b7762cca756d
    platform: linux/amd64

    depends_on:
      - mariadb

    # Laravel DB connection settings (points to `mariadb` service via Docker DNS).
    environment:
      DB_CONNECTION: mysql
      DB_HOST: mariadb
      DB_PORT: 3306
      DB_DATABASE: toolshop
      DB_USERNAME: user
      DB_PASSWORD: root

    # Named volume where the container provides the Laravel app code.
    volumes:
      - laravel-app-code:/var/www

  web:
    # Nginx serves Laravel /public and forwards PHP to laravel-api:9000.
    image: nginx:1.25-alpine

    depends_on:
      - laravel-api

    # Backend/API exposed to the host (default WEB_PORT=8091).
    ports:
      - "${WEB_PORT:-8091}:80"

    volumes:
      # Note: docker-compose.yml lives in docker/, so this relative path is correct.
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro

      # Nginx reads the same Laravel code volume as read-only.
      - laravel-app-code:/var/www:ro

  angular-ui:
    # Sprint 5 UI image pinned by digest (reproducible).
    image: testsmith/practice-software-testing-sprint5-ui@sha256:7d4f78475de46542aaba47df5900f7ff6d64cc4acef64784d81ad938d6eff112
    platform: linux/amd64

    depends_on:
      - web

    # Angular dev server exposed to the host (default UI_PORT=4200).
    ports:
      - "${UI_PORT:-4200}:4200"

    # Ensure the dev server listens on all interfaces inside the container.
    command: bash -c "ng serve --host 0.0.0.0 --port 4200"

volumes:
  # Shared application code volume between laravel-api (writer) and web (reader).
  laravel-app-code: